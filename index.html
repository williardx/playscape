<!DOCTYPE html>
<html lang="en">
<head>
    <title>Playscale</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
    body {
        font-family: Monospace;
        background-color: #f0f0f0;
        margin: 0px;
        overflow: hidden;
    }
    #info {
        position: absolute;
        top: 0px;
        width: 100%;
        padding: 5px;
        font-family:Monospace;
        font-size:13px;
        text-align:center;
        color: #ffffff;
    }
    a {
        color: #ffffff;
    }
    </style>
</head>

<body>

    <div id="container" style="display:none;"></div>

    <script>
        var camera, tick = 0,
            scene, renderer,
            controls, container,
            options, spawnerOptions, particleSystem;

        var canvasSource, video, contextSource, contextBlended;

        init();
        animate();

        function init() {
            initVideo();
            window.addEventListener( 'resize', onWindowResize, false );
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        }

        function initVideo() {
            canvasSource = document.createElement('canvas');
            canvasBlended = document.createElement('canvas');
            canvasSource.width = canvasBlended.width = 250;
            canvasSource.height = canvasBlended.height = 182;

            center = {x: window.innerWidth / 2, y: window.innerHeight / 2};

            contextBlended = canvasBlended.getContext('2d');
            contextSource = canvasSource.getContext('2d');

            video = document.createElement('video');

            document.body.insertBefore(canvasBlended, document.body.firstChild);
            document.body.insertBefore(canvasSource, document.body.firstChild);

            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || navigator.oGetUserMedia;
            if (navigator.getUserMedia) {
                navigator.getUserMedia({video: true}, function(stream) {
                    video.src = window.URL.createObjectURL(stream);
                    hasCamera = true;
                }, function(err) {
                });
            }
        }
        function fastAbs(value) {
            // equivalent to Math.abs();
            return (value ^ (value >> 31)) - (value >> 31);
        }

        function threshold(value) {
            return (value > 0x15) ? 0xFF : 0;
        }

        function differenceAccuracy(target, data) {
            var leftAvg = 0;
            var rightAvg = 0;
            var i = 0;
            var width = canvasSource.width;
            var x = 0; // x position / column
            var total = 0;

            // each pixel represented by 4 elements
            while (i < (data.length * 0.25)) {
                var average = (data[4*i] + data[4*i+1] + data[4*i+2]) / 3;
                if (x <= width / 2) { // left half of the screen
                  leftAvg += average;
                } else if (x > width / 2 && x < width) { // right half of the screen
                  rightAvg += average;
                } else { // increment down a row when we've reached the end
                    x = 0;
                    continue;
                }
                ++i;
                x++;
            }

            leftAvg /= (data.length * 0.125);
            rightAvg /= (data.length * 0.125);

            var i = 0;
            var x = 0;
            while (i < (data.length * 0.25)) {
              if (x > width) x = 0;
              target[4*i] = x <= width / 2 ? leftAvg : rightAvg;
              target[4*i+1] = x <= width / 2 ? leftAvg : rightAvg;
              target[4*i+2] = x <= width / 2 ? leftAvg : rightAvg;
              target[4*i+3] = 0xFF;

              ++i;
              x++;
            }

            console.log("left: " + leftAvg);
            console.log("right: " + rightAvg);

        }

        function blend() {
            var width = canvasSource.width;
            var height = canvasSource.height;
            var sourceData = contextSource.getImageData(0, 0, width, height);
            var blendedData = contextSource.createImageData(width, height);
            differenceAccuracy(blendedData.data, sourceData.data);
            contextBlended.putImageData(blendedData, 0, 0);
        }

        function animate() {
            requestAnimationFrame( animate );
            contextSource.drawImage(video, 0, 0, canvasSource.width, canvasSource.height);
            blend();
        }

        function render() {
            renderer.render( scene, camera );
        }

    </script>
</body>

</html>
